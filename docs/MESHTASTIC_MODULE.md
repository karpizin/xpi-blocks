# Техническая документация: Модуль Meshtastic Swarm

## 1. Обзор
Модуль `Meshtastic Swarm` предназначен для обеспечения децентрализованной связи между роботами (дронами) в условиях отсутствия стандартной сетевой инфраструктуры (Wi-Fi, 4G/5G). Использование технологии LoRa Mesh позволяет объединять устройства в единую сеть с дальностью до нескольких десятков километров.

---

## 2. Архитектура системы

Система состоит из трех основных уровней:

1.  **Hardware Layer**: Радиомодули (LoRa), прошитые ПО Meshtastic (Heltec, RAK, и др.).
2.  **Driver Layer (`blocks/drivers/meshtastic`)**: Python-обертка над библиотекой `meshtastic`, обеспечивающая абстракцию от низкоуровневого протокола.
3.  **Communication Layer (`src/xpi_comms`)**: ROS2-ноды, интегрирующие радиоканал в общую шину данных робота.

---

## 3. Компоненты модуля

### 3.1 MeshtasticDriver (`driver.py`)
Основной интерфейс для работы с оборудованием.
*   **Neighbor DB**: Хранит актуальное состояние всех видимых узлов в сети (ID, SNR, последняя телеметрия).
*   **Event System**: Использует коллбэки для уведомления системы о входящих данных.
*   **Методы**:
    *   `broadcast_telemetry(data)`: Рассылка пакета всем участникам.
    *   `send_command(target, cmd)`: Адресная отправка команды.

### 3.2 Meshtastic Bridge Node (`meshtastic_bridge_node.py`)
Мост между Mesh-сетью и ROS2.
*   **Подписки**: `/gps/fix` (NavSatFix), `~/outbound_broadcast` (String).
*   **Публикации**: `~/neighbors` (JSON String), `~/inbound_commands` (JSON String).
*   **Логика**: Каждое обновление локального GPS-фикса автоматически транслируется в Mesh для информирования соседей.

### 3.3 Swarm Controller (`swarm_controller_node.py`)
Пример логики управления роем.
*   Слушает координаты соседей через Bridge.
*   Вычисляет дистанцию между роботами.
*   **Collision Avoidance**: При опасном сближении (< 10м по умолчанию) генерирует команду отворота в топик `/cmd_vel`.

---

## 4. Установка и настройка

### Зависимости
Модуль требует наличия следующих Python-пакетов:
*   `meshtastic`
*   `pypubsub`

Системные требования:
*   Установленный `FFMPEG` (для работы с аудио-сэмплами в будущем).
*   Доступ к последовательному порту (обычно `/dev/ttyUSB0` или `/dev/ttyACM0`).

### Настройка прав (Linux)
Для работы с USB-модемом добавьте пользователя в группу `dialout`:
```bash
sudo usermod -a -G dialout $USER
```

---

## 5. Использование

### Запуск через Launch-файл
Для запуска всей системы (Bridge + Controller):
```bash
ros2 launch xpi_comms meshtastic_swarm.launch.py
```

### Параметры Launch-файла
*   `address`: Путь к устройству (например, `/dev/ttyUSB0` или IP-адрес для TCP).
*   `node_name`: Уникальный ID вашего робота в рое (например, `drone_leader`).
*   `safe_distance`: Порог срабатывания системы предотвращения столкновений.

---

## 6. Формат данных

### Телеметрия (JSON)
Передается в Mesh в следующем формате:
```json
{
  "id": "robot_01",
  "type": "telemetry",
  "lat": 55.7558,
  "lon": 37.6173,
  "alt": 150.5
}
```

### Команды (JSON)
Передаются в топик `~/inbound_commands`:
```json
{
  "from": "base_station",
  "cmd": {
    "action": "return_to_home",
    "params": {}
  }
}
```

---

## 7. Планы по развитию
1.  **Multi-Channel**: Поддержка раздельных каналов для телеметрии (быстрый) и команд (надежный).
2.  **Adaptive Sampling**: Изменение частоты передачи телеметрии в зависимости от скорости движения робота.
3.  **Encrypted Swarm**: Настройка AES-шифрования для закрытых групп роботов.
